<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Jefe - REG Marketing</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script src="database.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        html, body { min-height:100vh; font-family:'Outfit',sans-serif; }

        body {
            background: linear-gradient(135deg, #0D47A1 0%, #1565C0 45%, #1976D2 100%);
            display:flex; flex-direction:column; align-items:center;
            padding: 24px 16px 120px;
            position:relative; overflow-x:hidden;
        }

        .bg-circles { position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0; }
        .bg-circles span {
            position:absolute; border-radius:50%;
            background:rgba(255,255,255,0.04);
            animation:floatUp linear infinite;
        }
        .bg-circles span:nth-child(1){ width:80px;  height:80px;  left:7%;  animation-duration:20s; animation-delay:0s; }
        .bg-circles span:nth-child(2){ width:30px;  height:30px;  left:20%; animation-duration:14s; animation-delay:3s; }
        .bg-circles span:nth-child(3){ width:55px;  height:55px;  left:63%; animation-duration:18s; animation-delay:6s; }
        .bg-circles span:nth-child(4){ width:120px; height:120px; left:80%; animation-duration:25s; animation-delay:1s; }
        .bg-circles span:nth-child(5){ width:22px;  height:22px;  left:45%; animation-duration:12s; animation-delay:8s; }
        .bg-circles span:nth-child(6){ width:65px;  height:65px;  left:33%; animation-duration:21s; animation-delay:4s; }

        @keyframes floatUp {
            0%   { transform:translateY(110vh) rotate(0deg);   opacity:0; }
            8%   { opacity:1; } 92% { opacity:1; }
            100% { transform:translateY(-10vh) rotate(540deg); opacity:0; }
        }

        .wrapper {
            position:relative; z-index:1; width:100%; max-width:1200px;
            animation: pageIn 0.55s cubic-bezier(0.4,0,0.2,1);
        }
        @keyframes pageIn {
            from { opacity:0; transform:translateY(24px); }
            to   { opacity:1; transform:translateY(0); }
        }

        /* Header */
        .page-header { text-align:center; margin-bottom:28px; }
        .logo-wrap {
            width:82px; height:82px;
            background:rgba(255,255,255,0.92);
            border:3px solid rgba(255,255,255,0.95);
            border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            margin:0 auto 14px;
            box-shadow:0 8px 24px rgba(0,0,0,0.2);
        }
        .logo-wrap img { width:52px; height:52px; object-fit:contain; }
        .logo-wrap i   { font-size:2rem; color:#1565C0; display:none; }
        .page-header h1 {
            font-size:2rem; font-weight:800; color:white;
            letter-spacing:2px; text-shadow:0 2px 12px rgba(0,0,0,0.25); margin-bottom:4px;
        }
        .page-header .sub { font-size:0.88rem; color:rgba(255,255,255,0.75); }

        /* KPIs */
        .kpi-stats {
            display:grid;
            grid-template-columns:repeat(4,1fr);
            gap:16px; margin-bottom:24px;
        }
        .kpi-box {
            background:rgba(255,255,255,0.12);
            backdrop-filter:blur(10px);
            border:1.5px solid rgba(255,255,255,0.2);
            border-radius:18px; padding:20px;
            text-align:center; transition:all 0.3s ease;
            border-top: 4px solid;
        }
        .kpi-box:hover { background:rgba(255,255,255,0.18); transform:translateY(-3px); }
        .kpi-box.blue   { border-top-color:#42A5F5; }
        .kpi-box.orange { border-top-color:#FFA726; }
        .kpi-box.green  { border-top-color:#66BB6A; }
        .kpi-box.purple { border-top-color:#CE93D8; }
        .kpi-value {
            font-size:2.6rem; font-weight:800; color:white;
            text-shadow:0 2px 8px rgba(0,0,0,0.2); line-height:1; margin:6px 0;
        }
        .kpi-label { font-size:0.78rem; color:rgba(255,255,255,0.75); font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }

        /* T√≠tulo secci√≥n */
        .section-title-dashboard {
            color:white; font-size:1.3rem; font-weight:800;
            margin:0 0 16px 0; display:flex; align-items:center; gap:10px;
        }

        /* Cards de √≥rdenes */
        .orden-card {
            background:white; border-radius:18px; padding:22px;
            margin-bottom:16px;
            box-shadow:0 6px 20px rgba(0,0,0,0.12);
            transition:all 0.3s ease;
            border-left:5px solid #1565C0;
            animation: orderIn 0.4s ease both;
        }
        @keyframes orderIn { from{opacity:0;transform:translateX(-14px);}to{opacity:1;transform:translateX(0);} }
        .orden-card:hover { transform:translateY(-4px); box-shadow:0 12px 32px rgba(0,0,0,0.18); }

        .orden-numero { font-size:1.5rem; font-weight:800; color:#1565C0; }
        .orden-cliente { font-size:1rem; font-weight:700; color:#1A2332; margin-top:2px; }

        .orden-header {
            display:flex; justify-content:space-between; align-items:flex-start;
            margin-bottom:14px; padding-bottom:14px; border-bottom:2px solid #EEF2F7;
            gap:16px;
        }

        /* Imagen preview */
        .orden-imagen-preview {
            width:80px; height:80px; object-fit:cover;
            border-radius:12px; border:3px solid #1565C0;
            box-shadow:0 4px 12px rgba(0,0,0,0.18);
            cursor:pointer; transition:all 0.3s ease; flex-shrink:0;
        }
        .orden-imagen-preview:hover { transform:scale(1.06); }

        /* Info chips */
        .orden-info {
            display:flex; gap:8px; flex-wrap:wrap;
            font-size:0.82rem; margin-bottom:14px;
        }
        .orden-info-item {
            display:inline-flex; align-items:center; gap:5px;
            padding:4px 10px; border-radius:20px;
            background:#EEF2F7; color:#607D8B; font-weight:600;
        }

        /* Proceso grid */
        .proceso-grid {
            display:flex; flex-wrap:wrap; gap:10px; margin-top:14px;
        }
        .proceso-item {
            flex:1; min-width:100px;
            text-align:center; padding:12px 8px;
            border-radius:12px; transition:all 0.3s ease;
            border:2px solid;
        }
        .proceso-item.pendiente  { background:#FFF5F5; border-color:#FFCDD2; }
        .proceso-item.en-proceso { background:#FFF8E1; border-color:#FFE082; }
        .proceso-item.completado { background:#F1FFF3; border-color:#A5D6A7; }

        .proceso-icon { font-size:1.3rem; margin-bottom:6px; }
        .proceso-item.pendiente  .proceso-icon { color:#E53935; }
        .proceso-item.en-proceso .proceso-icon { color:#F57C00; }
        .proceso-item.completado .proceso-icon { color:#2E7D32; }

        .proceso-nombre  { font-size:0.78rem; font-weight:700; color:#1A2332; }
        .proceso-estado  { font-size:0.7rem;  color:#607D8B; margin-top:3px; }

        /* Botones acciones orden */
        .btn-accion {
            display:inline-flex; align-items:center; gap:6px;
            padding:8px 14px; border:none; border-radius:9px;
            font-family:'Outfit',sans-serif; font-size:0.82rem; font-weight:600;
            cursor:pointer; transition:all 0.25s ease;
        }
        .btn-accion.ver      { background:linear-gradient(135deg,#0D47A1,#1976D2); color:white; }
        .btn-accion.editar   { background:linear-gradient(135deg,#1B5E20,#2E7D32); color:white; }
        .btn-accion.eliminar { background:linear-gradient(135deg,#B71C1C,#E53935); color:white; }
        .btn-accion.completar{ background:linear-gradient(135deg,#1B5E20,#43A047); color:white; box-shadow:0 4px 14px rgba(27,94,32,0.35); }
        .btn-accion:hover { transform:translateY(-2px); filter:brightness(1.08); }

        /* Footer nav */
        .footer-nav {
            position:fixed; bottom:0; left:0; right:0;
            background:white; padding:14px 20px;
            box-shadow:0 -4px 20px rgba(0,0,0,0.15); z-index:1000;
        }
        .footer-nav-inner {
            max-width:1200px; margin:0 auto;
            display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
        }
        .btn-nav {
            display:inline-flex; align-items:center; gap:7px;
            padding:10px 18px; border:none; border-radius:10px;
            font-family:'Outfit',sans-serif; font-size:0.88rem; font-weight:600;
            cursor:pointer; transition:all 0.25s ease; text-decoration:none;
        }
        .btn-nav.primary   { background:linear-gradient(135deg,#0D47A1,#1976D2); color:white; }
        .btn-nav.success   { background:linear-gradient(135deg,#1B5E20,#2E7D32); color:white; }
        .btn-nav.purple    { background:linear-gradient(135deg,#4A148C,#7B1FA2); color:white; }
        .btn-nav.secondary { background:#607D8B; color:white; }
        .btn-nav.danger    { background:linear-gradient(135deg,#B71C1C,#E53935); color:white; }
        .btn-nav:hover { transform:translateY(-2px); filter:brightness(1.08); }

        /* Auto-refresh */
        .auto-refresh {
            position:fixed; top:16px; right:16px;
            background:white; padding:8px 14px; border-radius:20px;
            box-shadow:0 4px 14px rgba(0,0,0,0.18);
            font-size:0.8rem; font-weight:600; color:#2E7D32;
            display:flex; align-items:center; gap:6px;
            animation:pulse 2s infinite; z-index:1000;
            font-family:'Outfit',sans-serif;
        }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.65;} }

        /* Empty state */
        .empty-state {
            text-align:center; padding:60px 30px;
            background:white; border-radius:18px;
            box-shadow:0 8px 24px rgba(0,0,0,0.1);
        }
        .empty-state i { font-size:4rem; color:#CBD5E0; margin-bottom:16px; display:block; }
        .empty-state h3 { color:#1A2332; margin-bottom:8px; }
        .empty-state p  { color:#607D8B; }

        /* Notificaciones */
        .notification {
            position:fixed; top:20px; right:20px; padding:14px 22px;
            border-radius:12px; color:white; font-weight:600;
            font-family:'Outfit',sans-serif;
            box-shadow:0 8px 24px rgba(0,0,0,0.2); z-index:9999;
            animation:slideIn 0.3s ease; max-width:340px;
            display:flex; align-items:center; gap:8px;
        }
        .notification.success { background:linear-gradient(135deg,#2E7D32,#43A047); }
        .notification.error   { background:linear-gradient(135deg,#B71C1C,#E53935); }
        .notification.info    { background:linear-gradient(135deg,#0D47A1,#1976D2); }
        @keyframes slideIn  { from{transform:translateX(110%);opacity:0;} to{transform:translateX(0);opacity:1;} }
        @keyframes slideOut { from{transform:translateX(0);opacity:1;} to{transform:translateX(110%);opacity:0;} }

        @media (max-width:768px) {
            .kpi-stats { grid-template-columns:repeat(2,1fr); }
            .proceso-grid { gap:8px; }
            .proceso-item { min-width:80px; }
        }
        
    </style>
</head>
<body>
    <div class="bg-circles">
        <span></span><span></span><span></span><span></span><span></span><span></span>
    </div>

    <div class="wrapper">

        <div class="page-header">
            <div class="logo-wrap">
                <img src="logo.png" alt="REG" onerror="this.style.display='none';this.nextElementSibling.style.display='block';">
                <i class="fas fa-industry"></i>
            </div>
            <h1>REG MARKETING</h1>
            <p class="sub">Dashboard de Producci√≥n en Tiempo Real</p>
        </div>

        <!-- KPIs -->
        <div class="kpi-stats">
            <div class="kpi-box blue">
                <div class="kpi-label">√ìrdenes Activas</div>
                <div class="kpi-value" id="totalOrdenes">0</div>
            </div>
            <div class="kpi-box orange">
                <div class="kpi-label">En Proceso</div>
                <div class="kpi-value" id="enProceso">0</div>
            </div>
            <div class="kpi-box green">
                <div class="kpi-label">Completadas</div>
                <div class="kpi-value" id="completadas">0</div>
            </div>
            <div class="kpi-box purple">
                <div class="kpi-label">Pendientes</div>
                <div class="kpi-value" id="pendientes">0</div>
            </div>
        </div>

        <h2 class="section-title-dashboard">
            <i class="fas fa-clipboard-list"></i> √ìrdenes de Producci√≥n
        </h2>

        <div id="listaOrdenes"></div>

    </div>

    <!-- Footer nav -->
    <div class="footer-nav">
        <div class="footer-nav-inner">
            <a href="crear-orden.html" class="btn-nav primary">
                <i class="fas fa-plus-circle"></i> Nueva Orden
            </a>
            <a href="tablet-areas.html" class="btn-nav success">
                <i class="fas fa-tablet-alt"></i> Tablets
            </a>
            <button class="btn-nav purple" onclick="verHistorial()">
                <i class="fas fa-history"></i> Historial
            </button>
            <a href="index.html" class="btn-nav secondary">
                <i class="fas fa-home"></i> Inicio
            </a>
            <button class="btn-nav danger" onclick="cerrarSesion()">
                <i class="fas fa-sign-out-alt"></i> Salir
            </button>
        </div>
    </div>

    <div class="auto-refresh">
        <i class="fas fa-sync-alt fa-spin"></i> En tiempo real
    </div>

    <script>

        if (sessionStorage.getItem('jefeAutenticado') !== 'true') {
            window.location.href = 'login.html';
        }
        async function cargarOrdenes() {
            // Intentar cargar de Supabase primero
            let ordenes = await window.DB.obtenerOrdenes();

            // Si no hay conexi√≥n o falla, usar localStorage
            if (!ordenes || ordenes.length === 0) {
                ordenes = JSON.parse(localStorage.getItem('ordenes') || '[]');
            }
            const listaOrdenes = document.getElementById('listaOrdenes');
            
            if (ordenes.length === 0) {
                listaOrdenes.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No hay √≥rdenes de producci√≥n</h3>
                        <p>Crea la primera orden desde el formulario</p>
                        <a href="crear-orden.html" class="btn btn-primary" style="margin-top: 20px; text-decoration: none;">
                            <i class="fas fa-plus"></i> Crear Primera Orden
                        </a>
                    </div>
                `;
                actualizarEstadisticas(0, 0, 0, 0);
                return;
            }

            // Calcular estad√≠sticas
            let totalOrdenes = ordenes.length;
            let enProceso = 0;
            let completadas = 0;
            let pendientes = 0;

            ordenes.forEach(orden => {
                const estados = Object.values(orden.estado);
                const areasRequeridas = Object.keys(orden.requerimientos || {}).filter(k => orden.requerimientos[k]);
                const estadosRequeridos = areasRequeridas.map(a => orden.estado[a] || 'pendiente');
                const todasCompletadas = areasRequeridas.length > 0 && estadosRequeridos.every(e => e === 'completado');
                const algunaEnProceso = estadosRequeridos.some(e => e === 'en-proceso');
                const todasPendientes = estadosRequeridos.every(e => e === 'pendiente');

                if (todasCompletadas) {
                    completadas++;
                } else if (algunaEnProceso) {
                    enProceso++;
                } else if (todasPendientes) {
                    pendientes++;
                }
            });

            actualizarEstadisticas(totalOrdenes, enProceso, completadas, pendientes);
            // Generar HTML de √≥rdenes
            // Ordenar por fecha de entrega (m√°s urgentes primero)
            ordenes.sort((a, b) => {
                const dA = new Date(a.fechaEntrega + 'T12:00:00');
                const dB = new Date(b.fechaEntrega + 'T12:00:00');
                return dA - dB;
            });

            listaOrdenes.innerHTML = ordenes.map(orden => {
                const totalPrendas = orden.cantidadTotal || Object.values(orden.tallas || {}).reduce((sum, val) => sum + val, 0);

                const fechaObj = new Date(orden.fechaEntrega + 'T12:00:00'); fechaObj.setHours(0,0,0,0);
                const hoy = new Date(); hoy.setHours(0,0,0,0);
                const dias = Math.ceil((fechaObj - hoy) / 86400000);
                const colorFecha = dias < 0 ? 'white' : dias === 0 ? 'white' : dias <= 2 ? '#F57C00' : '#607D8B';
                const bgFecha = dias < 0 ? '#C62828' : dias === 0 ? '#FF6D00' : dias <= 2 ? '#FFF8E1' : '#EEF2F7';
                const borderFecha = dias < 0 ? '#C62828' : dias === 0 ? '#FF6D00' : dias <= 2 ? '#FFE082' : '#E0E0E0';
                const iconoFecha = dias < 0 ? '<i class="fas fa-circle-exclamation"></i>' : dias === 0 ? '<i class="fas fa-circle-exclamation"></i>' : dias <= 2 ? '<i class="fas fa-clock"></i>' : '';
                const textoFecha = dias < 0 ? `${Math.abs(dias)}d vencida` : dias === 0 ? 'Hoy' : `${dias}d restantes`;

                // Verificar si todas las √°reas requeridas est√°n completadas
                const areasRequeridas = Object.keys(orden.requerimientos || {}).filter(k => orden.requerimientos[k]);
                const todasCompletadas = areasRequeridas.length > 0 && areasRequeridas.every(a => orden.estado[a] === 'completado');

                // Color borde izquierdo seg√∫n urgencia
                const colorBorde = dias < 0 ? '#C62828' : dias === 0 ? '#FF6D00' : dias <= 2 ? '#F57C00' : '#1565C0';

                return `
                    <div class="orden-card" style="border-left-color:${colorBorde};">
                        <div class="orden-header">
                            <div style="display:flex;gap:14px;align-items:flex-start;">
                                ${orden.imagenDiseno
                                    ? `<img src="${orden.imagenDiseno}" class="orden-imagen-preview"
                                        onclick="ampliarImagen('${orden.imagenDiseno.replace(/'/g, "\\'")}')" alt="Dise√±o">`
                                    : `<div style="width:80px;height:80px;border-radius:12px;background:#F0F4F8;
                                        display:flex;align-items:center;justify-content:center;
                                        border:2px solid #E8EDF2;flex-shrink:0;">
                                        <i class="fas fa-tshirt" style="font-size:2rem;color:#CBD5E0;"></i>
                                    </div>`
                                }
                                <div>
                                    <div class="orden-numero">${orden.numeroOrden}</div>
                                    <div class="orden-cliente">${orden.cliente}</div>
                                    <div style="font-size:0.82rem;color:#607D8B;margin-top:2px;">${orden.tipoPrenda}</div>
                                </div>
                            </div>

                            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
                                <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
                                    <span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;
                                        border-radius:20px;font-size:0.78rem;font-weight:600;
                                        background:${bgFecha};color:${colorFecha};border:1.5px solid ${borderFecha};">
                                        <i class="fas fa-calendar-alt"></i>
                                        ${iconoFecha} ${new Date(orden.fechaEntrega + 'T12:00:00').toLocaleDateString('es-ES')} ¬∑ ${textoFecha}
                                    </span>
                                    <span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;
                                        border-radius:20px;font-size:0.78rem;font-weight:600;
                                        background:#EEF2F7;color:#1565C0;">
                                        <i class="fas fa-boxes"></i> ${totalPrendas} prendas
                                    </span>
                                </div>

                                <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
                                    <button class="btn-accion ver" onclick="event.stopPropagation();verOrdenCompleta('${orden.numeroOrden}')">
                                        <i class="fas fa-eye"></i> Ver
                                    </button>
                                    <button class="btn-accion editar" onclick="event.stopPropagation();editarOrden('${orden.numeroOrden}')">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn-accion eliminar" onclick="event.stopPropagation();eliminarOrden('${orden.numeroOrden}')">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                    ${todasCompletadas ? `
                                        <button class="btn-accion completar" onclick="event.stopPropagation();completarOrdenJefe('${orden.numeroOrden}')">
                                            <i class="fas fa-check-double"></i> Mover al Historial
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>

                        <div class="orden-info">
                            ${orden.tipoPrenda ? `<span class="orden-info-item"><i class="fas fa-tag"></i> ${orden.tipoPrenda}</span>` : ''}
                            ${orden.tela ? `<span class="orden-info-item"><i class="fas fa-scroll"></i> ${orden.tela}</span>` : ''}
                            ${orden.cuello ? `<span class="orden-info-item"><i class="fas fa-circle-notch"></i> ${orden.cuello}</span>` : ''}
                        </div>

                        <div class="proceso-grid">
                            ${orden.requerimientos?.corte      ? generarProceso('Corte',       'cut',           orden.estado.corte)      : ''}
                            ${orden.requerimientos?.confeccion ? generarProceso('Confecci√≥n',  'tshirt',        orden.estado.confeccion) : ''}
                            ${orden.requerimientos?.impresion  ? generarProceso('Impresi√≥n',   'print',         orden.estado.impresion)  : ''}
                            ${orden.requerimientos?.sublimacion? generarProceso('Sublimaci√≥n', 'fill-drip',     orden.estado.sublimacion): ''}
                            ${orden.requerimientos?.estampado  ? generarProceso('Estampado',   'stamp',         orden.estado.estampado)  : ''}
                            ${orden.requerimientos?.dtf        ? generarProceso('DTF',         'layer-group',   orden.estado.dtf)        : ''}
                            ${orden.requerimientos?.corteLaser ? generarProceso('Corte L√°ser', 'crosshairs',    orden.estado.corteLaser) : ''}
                            ${orden.requerimientos?.despacho   ? generarProceso('Despacho',    'shipping-fast', orden.estado.despacho)   : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generarProceso(nombre, icon, estado) {
            const estadosTexto = {
                'pendiente': 'Pendiente',
                'en-proceso': 'En Proceso',
                'completado': 'Completado'
            };

            return `
                <div class="proceso-item ${estado}">
                    <div class="proceso-icon">
                        <i class="fas fa-${icon}"></i>
                    </div>
                    <div class="proceso-nombre">${nombre}</div>
                    <div class="proceso-estado">${estadosTexto[estado]}</div>
                </div>
            `;
        }

        function actualizarEstadisticas(total, proceso, completas, pend) {
            document.getElementById('totalOrdenes').textContent = total;
            document.getElementById('enProceso').textContent = proceso;
            document.getElementById('completadas').textContent = completas;
            document.getElementById('pendientes').textContent = pend;
        }

        // Cargar al inicio
        cargarOrdenes();

        setInterval(async () => {
            let nuevasOrdenes = await window.DB.obtenerOrdenes();
            if (!nuevasOrdenes || nuevasOrdenes.length === 0) return;
            const anterior = localStorage.getItem('ordenes');
            const nuevo = JSON.stringify(nuevasOrdenes);
            if (anterior !== nuevo) {
                localStorage.setItem('ordenes', JSON.stringify(nuevasOrdenes));
                cargarOrdenes();
            }
        }, 8000);

        // Notificaci√≥n inicial
        setTimeout(() => {
            const notif = document.createElement('div');
            notif.className = 'notification info';
            notif.innerHTML = '<i class="fas fa-info-circle"></i> Dashboard en tiempo real activado';
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }, 500);
        function verOrdenCompleta(numeroOrden) {
            window.location.href = `ver-orden.html?orden=${numeroOrden}`;
        }
        // ===== SISTEMA DE LOGIN =====
        const CLAVE_JEFE = 'jefe2025'; // Cambiar aqu√≠ la clave

        if (sessionStorage.getItem('jefeAutenticado') !== 'true') {
    window.location.href = 'login.html';
}

        // Permitir Enter para login
        document.addEventListener('DOMContentLoaded', function() {
            const loginInput = document.getElementById('loginPassword');
            if (loginInput) {
                loginInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        verificarLogin();
                    }
                });
            }
            
            // Verificar si ya est√° autenticado
            const autenticado = localStorage.getItem('jefeAutenticado');
            if (autenticado === 'true') {
                document.getElementById('loginOverlay').style.display = 'none';
            }
        });
        async function completarOrdenJefe(numeroOrden) {
            const modal = document.createElement('div');
            modal.style.cssText = `position:fixed;top:0;left:0;width:100%;height:100%;
                background:rgba(0,0,0,0.8);display:flex;align-items:center;
                justify-content:center;z-index:99999;`;

            modal.innerHTML = `
                <div style="background:white;padding:40px;border-radius:20px;max-width:500px;
                    text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <i class="fas fa-check-double" style="font-size:4rem;color:#2E7D32;margin-bottom:20px;"></i>
                    <h2 style="color:#1A2332;margin-bottom:12px;">¬øMover al historial?</h2>
                    <p style="color:#607D8B;font-size:1rem;margin-bottom:28px;">
                        Todas las √°reas est√°n completadas. Esta orden se mover√° al historial y saldr√° del dashboard.
                    </p>
                    <div style="display:flex;gap:12px;justify-content:center;">
                        <button id="btnCancelarJefe" style="padding:12px 28px;border:none;border-radius:10px;
                            background:#EEF2F7;color:#607D8B;font-weight:600;cursor:pointer;font-size:0.95rem;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button id="btnConfirmarJefe" style="padding:12px 28px;border:none;border-radius:10px;
                            background:linear-gradient(135deg,#1B5E20,#2E7D32);color:white;
                            font-weight:700;cursor:pointer;font-size:0.95rem;
                            box-shadow:0 4px 14px rgba(27,94,32,0.35);">
                            <i class="fas fa-check"></i> S√≠, Mover
                        </button>
                    </div>
                </div>`;

            document.body.appendChild(modal);

            const respuesta = await new Promise(resolve => {
                document.getElementById('btnCancelarJefe').onclick = () => { modal.remove(); resolve(false); };
                document.getElementById('btnConfirmarJefe').onclick = () => { modal.remove(); resolve(true); };
                modal.onclick = e => { if (e.target === modal) { modal.remove(); resolve(false); } };
            });

            if (!respuesta) return;

            let ordenes = JSON.parse(localStorage.getItem('ordenes') || '[]');
            const orden = ordenes.find(o => o.numeroOrden === numeroOrden);
            if (!orden) return;

            await window.DB.moverAHistorial(orden);

            ordenes = ordenes.filter(o => o.numeroOrden !== numeroOrden);
            localStorage.setItem('ordenes', JSON.stringify(ordenes));

            let historial = JSON.parse(localStorage.getItem('historialOrdenes') || '[]');
            historial.push({ ...orden, fechaCompletado: new Date().toISOString() });
            localStorage.setItem('historialOrdenes', JSON.stringify(historial));

            mostrarNotificacion(`üéâ Orden ${numeroOrden} movida al historial`, 'success');
            cargarOrdenes();
        }
        // Bot√≥n de cerrar sesi√≥n (opcional)
        function cerrarSesion() {
            sessionStorage.removeItem('jefeAutenticado');
            window.location.href = 'login.html';
        }
        
        function verHistorial() {
            const historial = JSON.parse(localStorage.getItem('historialOrdenes') || '[]');

            const overlay = document.createElement('div');
            overlay.style.cssText = `position:fixed;top:0;left:0;width:100%;height:100%;
                background:rgba(13,71,161,0.75);backdrop-filter:blur(6px);
                display:flex;align-items:center;justify-content:center;
                z-index:99999;padding:20px;`;

            if (historial.length === 0) {
                overlay.innerHTML = `
                    <div style="background:white;border-radius:22px;padding:50px 40px;
                        max-width:480px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);
                        font-family:'Outfit',sans-serif;">
                        <div style="width:80px;height:80px;border-radius:50%;background:#EEF2F7;
                            display:flex;align-items:center;justify-content:center;margin:0 auto 20px;">
                            <i class="fas fa-inbox" style="font-size:2.2rem;color:#CBD5E0;"></i>
                        </div>
                        <h2 style="color:#1A2332;font-size:1.4rem;font-weight:800;margin-bottom:10px;">Historial Vac√≠o</h2>
                        <p style="color:#607D8B;margin-bottom:28px;">No hay √≥rdenes completadas a√∫n.</p>
                        <button id="btnCerrarVacio" style="padding:12px 32px;border:none;border-radius:12px;
                            background:linear-gradient(135deg,#0D47A1,#1976D2);color:white;
                            font-weight:700;font-size:0.95rem;cursor:pointer;font-family:'Outfit',sans-serif;">
                            Entendido
                        </button>
                    </div>`;
                document.body.appendChild(overlay);
                document.getElementById('btnCerrarVacio').onclick = () => overlay.remove();
                overlay.onclick = e => { if (e.target === overlay) overlay.remove(); };
                return;
            }

            let itemsHTML = historial.map((orden, i) => {
                const total = orden.cantidadTotal || Object.values(orden.tallas || {}).reduce((sum, val) => sum + val, 0);
                const fecha = new Date(orden.fechaCompletado || orden.fechaCreacion);
                return `
                    <div style="background:#F8FAFF;border:1.5px solid #E8EDF2;border-radius:14px;
                        padding:16px 20px;display:flex;align-items:center;gap:16px;
                        transition:all 0.2s;" onmouseover="this.style.borderColor='#1565C0'"
                        onmouseout="this.style.borderColor='#E8EDF2'">
                        ${orden.imagenDiseno
                            ? `<img src="${orden.imagenDiseno}" style="width:60px;height:60px;object-fit:cover;
                                border-radius:10px;border:2px solid #1565C0;flex-shrink:0;">`
                            : `<div style="width:60px;height:60px;border-radius:10px;background:#EEF2F7;
                                display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                                <i class="fas fa-tshirt" style="font-size:1.5rem;color:#CBD5E0;"></i>
                            </div>`
                        }
                        <div style="flex:1;min-width:0;">
                            <div style="font-size:1.1rem;font-weight:800;color:#1565C0;">${orden.numeroOrden}</div>
                            <div style="font-size:0.9rem;font-weight:600;color:#1A2332;margin-top:2px;">${orden.cliente}</div>
                            <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;">
                                <span style="font-size:0.75rem;padding:3px 8px;border-radius:20px;
                                    background:#EEF2F7;color:#607D8B;font-weight:600;">
                                    <i class="fas fa-tshirt"></i> ${orden.tipoPrenda}
                                </span>
                                <span style="font-size:0.75rem;padding:3px 8px;border-radius:20px;
                                    background:#E8F5E9;color:#2E7D32;font-weight:600;">
                                    <i class="fas fa-boxes"></i> ${total} uds
                                </span>
                                <span style="font-size:0.75rem;padding:3px 8px;border-radius:20px;
                                    background:#EEF2F7;color:#607D8B;font-weight:600;">
                                    <i class="fas fa-calendar-check"></i> ${fecha.toLocaleDateString('es-ES')}
                                </span>
                            </div>
                        </div>
                        <button onclick="window.open('ver-orden.html?orden=${orden.numeroOrden}&origen=historial','_blank')"
                            style="padding:9px 16px;border:none;border-radius:10px;cursor:pointer;
                            background:linear-gradient(135deg,#0D47A1,#1976D2);color:white;
                            font-weight:600;font-size:0.82rem;flex-shrink:0;font-family:'Outfit',sans-serif;
                            display:inline-flex;align-items:center;gap:6px;">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    </div>`;
            }).join('');

            overlay.innerHTML = `
                <div style="background:white;border-radius:22px;width:100%;max-width:780px;
                    max-height:88vh;overflow:hidden;display:flex;flex-direction:column;
                    box-shadow:0 20px 60px rgba(0,0,0,0.3);font-family:'Outfit',sans-serif;">

                    <!-- Header -->
                    <div style="padding:22px 28px 18px;border-bottom:2px solid #EEF2F7;
                        display:flex;justify-content:space-between;align-items:center;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div style="width:40px;height:40px;border-radius:10px;
                                background:linear-gradient(135deg,#0D47A1,#1976D2);
                                display:flex;align-items:center;justify-content:center;">
                                <i class="fas fa-history" style="color:white;font-size:1rem;"></i>
                            </div>
                            <div>
                                <div style="font-size:1.2rem;font-weight:800;color:#1A2332;">Historial de Producci√≥n</div>
                                <div style="font-size:0.78rem;color:#607D8B;">${historial.length} √≥rdenes completadas</div>
                            </div>
                        </div>
                        <button id="btnCerrarHistorial" style="width:36px;height:36px;border:none;border-radius:50%;
                            background:#EEF2F7;color:#607D8B;cursor:pointer;font-size:1rem;
                            display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Acciones -->
                    <div style="padding:14px 28px;border-bottom:1.5px solid #EEF2F7;display:flex;gap:10px;">
                        <button id="btnPDF" style="padding:9px 18px;border:none;border-radius:10px;cursor:pointer;
                            background:linear-gradient(135deg,#1B5E20,#2E7D32);color:white;
                            font-weight:600;font-size:0.85rem;font-family:'Outfit',sans-serif;
                            display:inline-flex;align-items:center;gap:7px;">
                            <i class="fas fa-file-pdf"></i> Generar Reporte PDF
                        </button>
                        <button id="btnLimpiar" style="padding:9px 18px;border:none;border-radius:10px;cursor:pointer;
                            background:#FFF5F5;color:#C62828;border:1.5px solid #FFCDD2;
                            font-weight:600;font-size:0.85rem;font-family:'Outfit',sans-serif;
                            display:inline-flex;align-items:center;gap:7px;">
                            <i class="fas fa-trash-alt"></i> Limpiar Historial
                        </button>
                    </div>

                    <!-- Lista -->
                    <div style="padding:20px 28px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;">
                        ${itemsHTML}
                    </div>
                </div>`;

            document.body.appendChild(overlay);

            document.getElementById('btnCerrarHistorial').onclick = () => overlay.remove();
            overlay.onclick = e => { if (e.target === overlay) overlay.remove(); };

            document.getElementById('btnPDF').onclick = () => {
                try { generarReporteMensualPDF(historial); } catch(e) { alert('Error PDF: ' + e.message); }
            };

            document.getElementById('btnLimpiar').onclick = async () => {
                const confirmar = await mostrarModalConfirmacion(
                    '¬øLimpiar historial?',
                    'Se eliminar√°n TODAS las √≥rdenes completadas. No se puede deshacer.',
                    'Cancelar', 'S√≠, Limpiar'
                );
                if (!confirmar) return;
                try {
                    await window.DB.limpiarHistorial();
                    localStorage.removeItem('historialOrdenes');
                    overlay.remove();
                    mostrarNotificacion('Historial limpiado', 'success');
                } catch(e) {
                    mostrarNotificacion('Error al limpiar', 'error');
                }
            };
        }

        // Funci√≥n para ver detalles de orden del historial
        function verOrdenCompletaHistorial(orden) {
            console.log('Ver orden del historial:', orden);
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 999999;
                overflow: auto;
                padding: 20px;
            `;
            
            let tallasHTML = '';
            for (let [talla, cantidad] of Object.entries(orden.tallas || {})) {
                if (cantidad > 0) {
                    tallasHTML += `<span style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; margin: 5px;">${talla}: ${cantidad}</span>`;
                }
            }
            
            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 20px; max-width: 800px; width: 100%;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #28a745; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> ORDEN COMPLETADA
                        </h2>
                        <h3 style="color: #333;">${orden.numeroOrden}</h3>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #666; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Informaci√≥n General</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div><strong>Cliente:</strong> ${orden.cliente}</div>
                            <div><strong>Tipo de Prenda:</strong> ${orden.tipoPrenda}</div>
                            <div><strong>Tipo de Cuello:</strong> ${orden.tipoCuello || 'N/A'}</div>
                            <div><strong>Marquilla:</strong> ${orden.marquilla || 'N/A'}</div>
                            <div><strong>Total Unidades:</strong> ${orden.total}</div>
                            <div><strong>Fecha Completado:</strong> ${new Date(orden.fechaCompletado || orden.fechaCreacion).toLocaleDateString()}</div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #666; margin-bottom: 15px;"><i class="fas fa-ruler"></i> Tallas</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${tallasHTML}
                        </div>
                    </div>
                    
                    ${orden.disenoUrl ? `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                        <h4 style="color: #666; margin-bottom: 15px;"><i class="fas fa-image"></i> Dise√±o</h4>
                        <img src="${orden.disenoUrl}" style="max-width: 100%; max-height: 400px; border-radius: 10px;" />
                    </div>
                    ` : ''}
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button id="cerrarDetalleHistorial" class="btn btn-secondary" style="padding: 12px 30px;">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('cerrarDetalleHistorial').onclick = () => {
                modal.remove();
            };
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        function exportarHistorial() {
            const historial = JSON.parse(localStorage.getItem('historialOrdenes') || '[]');
            
            if (historial.length === 0) {
                // Modal bonito cuando no hay historial
                const modalVacio = document.createElement('div');
                modalVacio.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                `;
                
                modalVacio.innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <i class="fas fa-inbox" style="font-size: 5rem; color: #95a5a6; margin-bottom: 20px;"></i>
                        <h2 style="color: #2c3e50; margin-bottom: 15px;">Historial Vac√≠o</h2>
                        <p style="color: #7f8c8d; font-size: 1.1rem; margin-bottom: 30px;">
                            No hay √≥rdenes completadas en el historial a√∫n.
                        </p>
                        <button id="cerrarModalVacio" class="btn btn-primary" style="padding: 12px 30px;">
                            <i class="fas fa-check"></i> Entendido
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modalVacio);
                
                document.getElementById('cerrarModalVacio').onclick = () => {
                    modalVacio.remove();
                };
                
                // Cerrar al hacer clic fuera
                modalVacio.onclick = (e) => {
                    if (e.target === modalVacio) {
                        modalVacio.remove();
                    }
                };
                
                return;
            }
            
            const csv = [
                ['N√∫mero Orden', 'Cliente', 'Fecha Completado', 'Total Prendas', 'Tipo Prenda'].join(','),
                ...historial.map(orden => {
                    const total = Object.values(orden.tallas).reduce((sum, val) => sum + val, 0);
                    const fecha = new Date(orden.fechaCompletado).toLocaleDateString('es-ES');
                    return [
                        orden.numeroOrden,
                        orden.cliente,
                        fecha,
                        total,
                        orden.tipoPrenda
                    ].join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historial_ordenes_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            

            mostrarNotificacion('‚úÖ Historial exportado', 'success');
        }

        function ampliarImagen(imagenSrc) {
        const modal = document.createElement('div');
        modal.id = 'modalImagenAmpliada';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            cursor: zoom-out;
        `;
        
        const contenedor = document.createElement('div');
        contenedor.style.cssText = 'position: relative;';
        
        const img = document.createElement('img');
        img.src = imagenSrc;
        img.style.cssText = 'max-width: 90vw; max-height: 90vh; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);';
        
        const btnCerrar = document.createElement('button');
        btnCerrar.textContent = '‚úï';
        btnCerrar.style.cssText = `
            position: absolute;
            top: -20px;
            right: -20px;
            background: #f44336;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.5);
            transition: all 0.3s ease;
        `;
        
        btnCerrar.onmouseover = () => { btnCerrar.style.transform = 'scale(1.1)'; };
        btnCerrar.onmouseout = () => { btnCerrar.style.transform = 'scale(1)'; };
        
        btnCerrar.addEventListener('click', function(e) {
            e.stopPropagation();
            modal.remove();
        });
        
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        contenedor.appendChild(img);
        contenedor.appendChild(btnCerrar);
        modal.appendChild(contenedor);
        document.body.appendChild(modal);
    }

    function mostrarNotificacion(mensaje, tipo) {
        const notif = document.createElement('div');
        notif.className = `notification ${tipo}`;
        notif.textContent = mensaje;
        document.body.appendChild(notif);
        
        setTimeout(() => {
            notif.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notif.remove(), 300);
        }, 3000);
    }
    async function limpiarHistorial() {
        if (!confirm('‚ö†Ô∏è ¬øEst√°s SEGURO de eliminar TODO el historial?\n\nEsta acci√≥n NO se puede deshacer.')) {
            return;
        }
        
        if (!confirm('‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN\n\nSe eliminar√°n TODAS las √≥rdenes completadas.\n¬øContinuar?')) {
            return;
        }
        
        try {
            // Limpiar localStorage
            localStorage.removeItem('historialOrdenes');
            
            mostrarNotificacion('üóëÔ∏è Historial limpiado correctamente', 'success');
            
            // Cerrar modal
            document.querySelector('.modal-overlay')?.remove();
            
        } catch (error) {
            console.error('Error al limpiar historial:', error);
            mostrarNotificacion('‚ùå Error al limpiar historial', 'error');
        }
    }
    async function eliminarOrden(numeroOrden) {
        // Modal bonito
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        `;
        
        modal.innerHTML = `
            <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <i class="fas fa-trash-alt" style="font-size: 4rem; color: #f44336; margin-bottom: 20px;"></i>
                <h2 style="color: #333; margin-bottom: 15px;">¬øEliminar la orden ${numeroOrden}?</h2>
                <p style="color: #666; font-size: 1.1rem; margin-bottom: 30px;">
                    Esta acci√≥n <strong>NO se puede deshacer</strong>
                </p>
                <div style="display:flex;gap:12px;justify-content:center;">
                    <button id="btnCancelar" style="padding:12px 28px;border:none;border-radius:12px;
                        background:#EEF2F7;color:#607D8B;font-weight:600;cursor:pointer;
                        font-size:0.95rem;font-family:'Outfit',sans-serif;
                        display:inline-flex;align-items:center;gap:7px;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button id="btnEliminar" style="padding:12px 28px;border:none;border-radius:12px;
                        background:linear-gradient(135deg,#B71C1C,#E53935);color:white;
                        font-weight:700;cursor:pointer;font-size:0.95rem;font-family:'Outfit',sans-serif;
                        box-shadow:0 4px 14px rgba(183,28,28,0.35);
                        display:inline-flex;align-items:center;gap:7px;">
                        <i class="fas fa-trash"></i> S√≠, Eliminar
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const respuesta = await new Promise(resolve => {
            document.getElementById('btnCancelar').onclick = () => {
                modal.remove();
                resolve(false);
            };
            document.getElementById('btnEliminar').onclick = () => {
                modal.remove();
                resolve(true);
            };
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                    resolve(false);
                }
            };
        });
        
        if (!respuesta) return;
        
        try {
            // Eliminar de Supabase
            const resultado = await window.DB.eliminarOrden(numeroOrden);
            
            if (resultado.success) {
                // Tambi√©n eliminar de localStorage
                let ordenes = JSON.parse(localStorage.getItem('ordenes') || '[]');
                ordenes = ordenes.filter(o => o.numeroOrden !== numeroOrden);
                localStorage.setItem('ordenes', JSON.stringify(ordenes));
                
                mostrarNotificacion(`üóëÔ∏è Orden ${numeroOrden} eliminada`, 'success');
                cargarOrdenes();
            } else {
                throw new Error(resultado.error);
            }
        } catch (error) {
            console.error('Error al eliminar:', error);
            mostrarNotificacion('‚ùå Error al eliminar orden', 'error');
        }
    }
    function editarOrden(numeroOrden) {
        window.location.href = `crear-orden.html?editar=${numeroOrden}`;
    }

    function generarReporteMensualPDF(historial) {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

            const azul      = [13, 71, 161];
            const azulMedio = [21, 101, 192];
            const azulClaro = [227, 242, 253];
            const grisClaro = [248, 250, 252];
            const grisLinea = [226, 232, 240];
            const verde     = [27, 94, 32];
            const blanco    = [255, 255, 255];

            const hoy = new Date();
            const mesNombre = hoy.toLocaleString('es-ES', { month: 'long' });
            const anio = hoy.getFullYear();
            const fechaGenerado = hoy.toLocaleDateString('es-ES', { day:'2-digit', month:'long', year:'numeric' });
            const horaGenerado  = hoy.toLocaleTimeString('es-ES', { hour:'2-digit', minute:'2-digit' });

            const ordenesDelMes = historial.filter(o => {
                const f = new Date(o.fechaCompletado || o.fechaCreacion);
                return f.getMonth() === hoy.getMonth() && f.getFullYear() === hoy.getFullYear();
            });

            if (ordenesDelMes.length === 0) {
                alert('No hay √≥rdenes completadas este mes.');
                return;
            }

            const totalUnidades = ordenesDelMes.reduce((sum, o) => {
                return sum + (o.cantidadTotal || Object.values(o.tallas || {}).reduce((s, v) => s + v, 0));
            }, 0);
            const promedio = Math.round(totalUnidades / ordenesDelMes.length);

            const W = 210, M = 14;

            // ‚îÄ‚îÄ ENCABEZADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            doc.setFillColor(...azul);
            doc.rect(0, 0, W, 52, 'F');

            // C√≠rculo logo
            doc.setFillColor(...blanco);
            doc.circle(M + 14, 26, 14, 'F');
            try {
                const logoEl = document.querySelector('img[src="logo.png"]');
                if (logoEl) doc.addImage(logoEl.src, 'PNG', M + 3, 15, 22, 22);
            } catch(e) {}

            // Textos encabezado
            doc.setTextColor(...blanco);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.text('REG MARKETING S.A.S', W / 2, 20, { align: 'center' });

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text('REPORTE MENSUAL DE PRODUCCI√ìN', W / 2, 29, { align: 'center' });

            doc.setFontSize(13);
            doc.setFont('helvetica', 'bold');
            doc.text(`${mesNombre.toUpperCase()} ${anio}`, W / 2, 39, { align: 'center' });

            doc.setFontSize(7.5);
            doc.setFont('helvetica', 'normal');
            doc.text(`Generado el ${fechaGenerado} a las ${horaGenerado}`, W / 2, 47, { align: 'center' });

            // L√≠nea decorativa
            doc.setDrawColor(...azulClaro);
            doc.setLineWidth(0.5);
            doc.line(M, 52, W - M, 52);

            let y = 60;

            // ‚îÄ‚îÄ TARJETAS KPI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const cardW = (W - M * 2 - 8) / 3;
            const kpis = [
                { label: '√ìrdenes Completadas', value: ordenesDelMes.length, color: azulMedio },
                { label: 'Unidades Producidas',  value: totalUnidades,        color: verde },
                { label: 'Promedio por Orden',   value: promedio,             color: [74, 20, 140] }
            ];

            kpis.forEach((kpi, i) => {
                const x = M + i * (cardW + 4);
                doc.setFillColor(...grisClaro);
                doc.roundedRect(x, y, cardW, 22, 3, 3, 'F');
                doc.setDrawColor(...kpi.color);
                doc.setLineWidth(0.8);
                doc.line(x, y, x, y + 22);

                doc.setTextColor(...kpi.color);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.text(kpi.value.toString(), x + cardW / 2, y + 13, { align: 'center' });

                doc.setTextColor(96, 125, 139);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7.5);
                doc.text(kpi.label.toUpperCase(), x + cardW / 2, y + 19, { align: 'center' });
            });

            y += 30;

            // ‚îÄ‚îÄ T√çTULO TABLA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            doc.setFillColor(...azul);
            doc.roundedRect(M, y, W - M * 2, 9, 2, 2, 'F');
            doc.setTextColor(...blanco);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('DETALLE DE √ìRDENES DEL MES', W / 2, y + 6.2, { align: 'center' });

            y += 13;

            // ‚îÄ‚îÄ TABLA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const cols = [
                { header: 'N¬∞ Orden', width: 22, align: 'center' },
                { header: 'Cliente',  width: 48, align: 'left'   },
                { header: 'Tipo de Prenda', width: 52, align: 'left' },
                { header: 'Unidades', width: 22, align: 'center' },
                { header: 'Completada', width: 28, align: 'center' }
            ];

            // Header fila
            let x = M;
            doc.setFillColor(...azulClaro);
            doc.rect(M, y, W - M * 2, 8, 'F');
            cols.forEach(col => {
                doc.setTextColor(...azulMedio);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(8);
                doc.text(col.header, col.align === 'center' ? x + col.width / 2 : x + 2, y + 5.5,
                    { align: col.align === 'center' ? 'center' : 'left' });
                x += col.width;
            });

            y += 8;

            // Filas de datos
            ordenesDelMes.forEach((orden, idx) => {
                if (y > 265) {
                    doc.addPage();
                    y = 20;
                }

                const total = orden.cantidadTotal || Object.values(orden.tallas || {}).reduce((s, v) => s + v, 0);
                const fechaComp = new Date(orden.fechaCompletado || orden.fechaCreacion).toLocaleDateString('es-ES', { day:'2-digit', month:'2-digit', year:'2-digit' });
                const fechaEnt  = orden.fechaEntrega ? new Date(orden.fechaEntrega + 'T12:00:00').toLocaleDateString('es-ES', { day:'2-digit', month:'2-digit', year:'2-digit' }) : '-';

                const rowH = 8;
                const bg = idx % 2 === 0 ? blanco : grisClaro;
                doc.setFillColor(...bg);
                doc.rect(M, y, W - M * 2, rowH, 'F');

                // L√≠nea inferior fila
                doc.setDrawColor(...grisLinea);
                doc.setLineWidth(0.2);
                doc.line(M, y + rowH, W - M, y + rowH);

                const valores = [
                    { v: orden.numeroOrden, align: 'center' },
                    { v: orden.cliente,     align: 'left'   },
                    { v: orden.tipoPrenda,  align: 'left'   },
                    { v: total.toString(),  align: 'center' },
                    { v: fechaComp,         align: 'center' }
                ];

                x = M;
                valores.forEach((val, vi) => {
                    const col = cols[vi];
                    doc.setTextColor(26, 35, 50);
                    doc.setFont('helvetica', vi === 0 ? 'bold' : 'normal');
                    doc.setFontSize(8);
                    const txt = doc.splitTextToSize(val.v || '-', col.width - 3);
                    doc.text(txt[0], val.align === 'center' ? x + col.width / 2 : x + 2, y + 5.2,
                        { align: val.align === 'center' ? 'center' : 'left' });
                    x += col.width;
                });

                y += rowH;
            });

            // L√≠nea cierre tabla
            doc.setDrawColor(...azulMedio);
            doc.setLineWidth(0.5);
            doc.line(M, y, W - M, y);

            y += 10;

            // ‚îÄ‚îÄ RESUMEN FINAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (y < 245) {
                doc.setFillColor(...grisClaro);
                doc.roundedRect(M, y, W - M * 2, 22, 3, 3, 'F');
                doc.setDrawColor(...azulMedio);
                doc.setLineWidth(0.5);
                doc.roundedRect(M, y, W - M * 2, 22, 3, 3, 'S');

                doc.setTextColor(...azul);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('RESUMEN DEL PER√çODO', M + 5, y + 7);

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8.5);
                doc.setTextColor(26, 35, 50);
                doc.text(`Total de √≥rdenes completadas: ${ordenesDelMes.length}`, M + 5, y + 14);
                doc.text(`Total de unidades producidas: ${totalUnidades}`, M + 5, y + 19.5);
                doc.text(`Promedio de unidades por orden: ${promedio}`, W / 2, y + 14);
                doc.text(`Mes reportado: ${mesNombre} ${anio}`, W / 2, y + 19.5);
            }

            // ‚îÄ‚îÄ PIE DE P√ÅGINA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                const pageH = doc.internal.pageSize.height;

                doc.setFillColor(...azul);
                doc.rect(0, pageH - 12, W, 12, 'F');

                doc.setTextColor(...blanco);
                doc.setFontSize(7.5);
                doc.setFont('helvetica', 'normal');
                doc.text('REG MARKETING S.A.S ‚Äî Sistema de Gesti√≥n de Producci√≥n Textil', M, pageH - 4.5);
                doc.text(`P√°gina ${i} de ${pageCount}`, W - M, pageH - 4.5, { align: 'right' });
            }

            doc.save(`Reporte_Produccion_${mesNombre}_${anio}.pdf`);

        } catch(error) {
            console.error('Error PDF:', error);
            alert('Error al generar PDF: ' + error.message);
        }
    }

    function mostrarModalConfirmacion(titulo, mensaje, textoNo, textoSi) {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.style.cssText = `position:fixed;top:0;left:0;width:100%;height:100%;
                background:rgba(13,71,161,0.75);backdrop-filter:blur(6px);
                display:flex;align-items:center;justify-content:center;
                z-index:999999;padding:20px;`;

            modal.innerHTML = `
                <div style="background:white;padding:40px;border-radius:22px;max-width:460px;
                    text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);
                    font-family:'Outfit',sans-serif;animation:pageIn 0.3s ease;">
                    <div style="width:72px;height:72px;border-radius:50%;
                        background:#FFF8E1;display:flex;align-items:center;
                        justify-content:center;margin:0 auto 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size:2rem;color:#F57C00;"></i>
                    </div>
                    <h2 style="color:#1A2332;font-size:1.3rem;font-weight:800;margin-bottom:10px;">${titulo}</h2>
                    <p style="color:#607D8B;font-size:0.95rem;margin-bottom:28px;line-height:1.6;">${mensaje}</p>
                    <div style="display:flex;gap:12px;justify-content:center;">
                        <button id="btnNo" style="padding:12px 28px;border:none;border-radius:12px;
                            background:#EEF2F7;color:#607D8B;font-weight:600;cursor:pointer;
                            font-size:0.95rem;font-family:'Outfit',sans-serif;
                            display:inline-flex;align-items:center;gap:7px;transition:all 0.2s;">
                            <i class="fas fa-times"></i> ${textoNo}
                        </button>
                        <button id="btnSi" style="padding:12px 28px;border:none;border-radius:12px;
                            background:linear-gradient(135deg,#B71C1C,#E53935);color:white;
                            font-weight:700;cursor:pointer;font-size:0.95rem;font-family:'Outfit',sans-serif;
                            box-shadow:0 4px 14px rgba(183,28,28,0.35);
                            display:inline-flex;align-items:center;gap:7px;transition:all 0.2s;">
                            <i class="fas fa-check"></i> ${textoSi}
                        </button>
                    </div>
                </div>`;

            document.body.appendChild(modal);
            document.getElementById('btnNo').onclick  = () => { modal.remove(); resolve(false); };
            document.getElementById('btnSi').onclick  = () => { modal.remove(); resolve(true); };
            modal.onclick = e => { if (e.target === modal) { modal.remove(); resolve(false); } };
        });
    }
    </script>
</body>
</html>
